<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8">
<title>AI VTuber - Golden New Year (Stable v2.1)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<style>
    /* ÂÖ®ÂüüË®≠ÂÆö */
    * { box-sizing: border-box; }

    body {
        margin: 0; padding: 0; overflow: hidden;
        background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 50%, #ffe0b2 100%);
        font-family: "Noto Sans TC", sans-serif;
        overscroll-behavior: none; 
        width: 100vw; height: 100dvh; 
    }
    
    #loading-screen {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255, 255, 255, 0.95);
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        z-index: 999; transition: opacity 0.5s ease;
    }
    
    .loader {
        border: 4px solid #fff3e0; border-top: 4px solid #d32f2f;
        border-radius: 50%; width: 40px; height: 40px;
        animation: spin 1s linear infinite; margin-bottom: 15px;
    }

    .loading-text { color: #d32f2f; font-size: 1rem; font-weight: bold; margin-bottom: 20px; }

    #start-btn {
        padding: 12px 30px; font-size: 1.1rem;
        background: linear-gradient(to right, #d32f2f, #f44336);
        color: #ffd700; border: 2px solid #ffd700; border-radius: 50px;
        cursor: pointer; display: none;
        box-shadow: 0 4px 15px rgba(211, 47, 47, 0.3);
        transition: transform 0.2s; font-weight: bold;
        touch-action: manipulation; -webkit-tap-highlight-color: transparent;
    }
    #start-btn:active { transform: scale(0.95); }

    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    #api-status {
        position: absolute; top: 15px; right: 15px; padding: 6px 12px;
        background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(4px);
        border-radius: 20px; font-size: 12px; font-weight: bold;
        color: #333; display: flex; align-items: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 100;
        border: 1px solid #ffcc80;
    }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: #ccc; margin-right: 6px; }
    .status-connected { background-color: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
    .status-error { background-color: #e74c3c; box-shadow: 0 0 5px #e74c3c; }

    #file-status {
        position: absolute; top: 15px; left: 15px; padding: 10px;
        background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(4px);
        border-radius: 12px; font-size: 12px; color: #5d4037;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 100;
        border: 1px solid #ffcc80; pointer-events: none;
    }

    #tts-debug {
        position: absolute; top: 120px; left: 10px;
        background: rgba(0, 0, 0, 0.85); color: #00ff00;
        font-family: monospace; font-size: 10px; padding: 8px;
        border-radius: 8px; width: 220px; max-height: 150px;
        overflow-y: auto; z-index: 9999; display: none;
        border: 1px solid #00ff00; pointer-events: none;
    }

    #chat-container {
        position: absolute; bottom: calc(30px + env(safe-area-inset-bottom));
        left: 50%; transform: translateX(-50%); width: 90%; max-width: 600px;
        display: flex; flex-direction: column; gap: 8px; z-index: 100;
    }

    #chat-display {
        background: rgba(255, 255, 255, 0.5); padding: 12px; border-radius: 16px;
        height: 140px; overflow-y: auto; backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 215, 0, 0.5);
        display: flex; flex-direction: column; gap: 8px;
    }

    .message { padding: 8px 12px; border-radius: 12px; max-width: 85%; font-size: 14px; }
    .message-user { align-self: flex-end; background: #1e88e5; color: white; }
    .message-ai { align-self: flex-start; background: white; border: 1px solid #ffd700; color: #333; }
    .message-system { align-self: center; font-size: 11px; color: #e65100; font-style: italic; }

    #input-area { display: flex; gap: 8px; }
    #user-input {
        flex: 1; padding: 12px 16px; border-radius: 25px; border: 1px solid #ffd700;
        background: white; font-size: 16px; outline: none;
    }
    .control-btn {
        width: 44px; height: 44px; border-radius: 50%; border: 1px solid #ffd700;
        background: white; cursor: pointer; display: flex; justify-content: center; align-items: center;
    }
    #send-btn {
        padding: 0 20px; border-radius: 22px; border: none;
        background: #1976d2; color: white; font-weight: bold; cursor: pointer;
    }
    #send-btn:disabled { background: #ccc; }
    #dance-btn.active { background: #e91e63; color: white; }
</style>

<script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>
<script type="importmap">
{
    "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.169.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/",
        "@pixiv/three-vrm": "https://unpkg.com/@pixiv/three-vrm@3.0.0/lib/three-vrm.module.js",
        "@pixiv/three-vrm-animation": "https://unpkg.com/@pixiv/three-vrm-animation@3.0.0/lib/three-vrm-animation.module.js"
    }
}
</script>
</head>
<body>

<div id="loading-screen">
    <div class="loader"></div>
    <div class="loading-text" id="status-text">ÂàùÂßãÂåñÁ≥ªÁµ±‰∏≠...</div>
    <button id="start-btn">ÈÄ≤ÂÖ•Êñ∞Êò•‰∏ñÁïå</button>
</div>

<div id="file-status">ËºâÂÖ•Ë≥áÊ∫ê‰∏≠...</div>
<div id="api-status"><div class="status-dot" id="status-dot"></div><span id="status-msg">ÈÄ£Á∑ö‰∏≠</span></div>
<div id="tts-debug"></div>

<div id="chat-container">
    <div id="chat-display"></div>
    <div id="input-area">
        <button id="dance-btn" class="control-btn">üíÉ</button>
        <button id="mute-btn" class="control-btn">üîä</button>
        <input type="text" id="user-input" placeholder="Ë™™ÈªûÊñ∞Âπ¥Á•ùÁ¶èÂêß..." disabled>
        <button id="send-btn" disabled>ÁôºÈÄÅ</button>
    </div>
</div>

<script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { VRMLoaderPlugin, VRMUtils } from '@pixiv/three-vrm';
    import { VRMAnimationLoaderPlugin, createVRMAnimationClip } from '@pixiv/three-vrm-animation';

    const API_URL = "/api/chat";
    const isAndroid = /Android/i.test(navigator.userAgent);
    
    // --- ÂÖ®ÂüüËÆäÊï∏ ---
    let currentVrms = [];
    let mixers = [];
    let isDancing = false;
    let isSpeaking = false;
    let isMuted = false;
    let chatHistory = [];
    
    // È†êÂÖàËºâÂÖ•ÁöÑÂãïÁï´
    let danceActionsMap = [];
    let talkAnimations = [null, null];
    let idleAnimations = [null, null];

    const DANCE_URLS = [
        'https://davidkuodcam-crypto.github.io/VTuber/Breakdance_Freeze_Var_3.vrma',
        'https://davidkuodcam-crypto.github.io/VTuber/Flair.vrma',
        'https://davidkuodcam-crypto.github.io/VTuber/Hip_Hop_Dancing.vrma',
        'https://davidkuodcam-crypto.github.io/VTuber/Breakdance_Freeze_Var_1.vrma'
    ];

    const MODEL_CONFIGS = [
        { url: 'https://davidkuodcam-crypto.github.io/VTuber/AvatarSample_C.vrm', pos: [-0.4, 0, 0.2], talk: 'https://davidkuodcam-crypto.github.io/VTuber/Breathing_Idle.vrma', idle: 'https://davidkuodcam-crypto.github.io/VTuber/Taunt_with_Skin.vrma' },
        { url: 'https://davidkuodcam-crypto.github.io/VTuber/AvatarSample_W.vrm', pos: [0.4, 0, -0.6], talk: 'https://davidkuodcam-crypto.github.io/VTuber/Talking_01.vrma', idle: 'https://davidkuodcam-crypto.github.io/VTuber/Idle_01.vrma' }
    ];

    const BGM_URL = 'https://davidkuodcam-crypto.github.io/VTuber/Happy_new_year.mp3';
    const bgm = new Audio(BGM_URL);
    bgm.loop = true;

    // --- ÂàùÂßãÂåñ Three.js ---
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xfff8e1);
    const camera = new THREE.PerspectiveCamera(30.0, window.innerWidth / window.innerHeight, 0.1, 20.0);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    const light = new THREE.DirectionalLight(0xffffff, 1.5);
    light.position.set(1, 2, 1);
    scene.add(light, new THREE.AmbientLight(0xffffff, 0.6));

    function updateCamera(dancing) {
        if (window.innerWidth / window.innerHeight < 0.8) {
            dancing ? camera.position.set(0, 0.8, 8) : camera.position.set(0, 1.35, 2.5);
        } else {
            dancing ? camera.position.set(0, 1, 6) : camera.position.set(0, 1.4, 3.5);
        }
        controls.target.set(0, dancing ? 0.8 : 1.3, 0);
        controls.update();
    }
    updateCamera(false);

    // --- ËºâÂÖ•Ê†∏ÂøÉÈÇèËºØ ---
    const loader = new GLTFLoader();
    loader.register(parser => new VRMLoaderPlugin(parser));
    loader.register(parser => new VRMAnimationLoaderPlugin(parser));

    async function init() {
        const statusText = document.getElementById('status-text');
        
        // 1. ËºâÂÖ•Ê®°Âûã
        statusText.innerText = "Âè¨ÂñöËßíËâ≤‰∏≠...";
        for (let i = 0; i < MODEL_CONFIGS.length; i++) {
            const config = MODEL_CONFIGS[i];
            const gltf = await loader.loadAsync(config.url);
            const vrm = gltf.userData.vrm;
            VRMUtils.rotateVRM0(vrm);
            vrm.scene.position.set(...config.pos);
            scene.add(vrm.scene);
            const mixer = new THREE.AnimationMixer(vrm.scene);
            
            // ‚≠ê ‰øÆÂæ©ÔºöÊâãÂãïÂàùÂßãÂåñ userDataÔºåÈò≤Ê≠¢ undefined ÈåØË™§
            if (!vrm.userData) {
                vrm.userData = {};
            }
            vrm.userData.mixer = mixer;
            
            mixers.push(mixer);
            currentVrms.push(vrm);
        }

        // 2. È†êËºâÂãïÁï´
        statusText.innerText = "Á∑®ÊéíËàûËπàËàáÂ∞çË©±...";
        for (let i = 0; i < currentVrms.length; i++) {
            const vrm = currentVrms[i];
            const cfg = MODEL_CONFIGS[i];
            
            // ËºâÂÖ•Ë™™Ë©±ËàáÈñíÁΩÆ
            const talkGltf = await loader.loadAsync(cfg.talk);
            const idleGltf = await loader.loadAsync(cfg.idle);
            
            const talkClip = createVRMAnimationClip(talkGltf.userData.vrmAnimations[0], vrm);
            const idleClip = createVRMAnimationClip(idleGltf.userData.vrmAnimations[0], vrm);
            
            talkAnimations[i] = vrm.userData.mixer.clipAction(talkClip);
            idleAnimations[i] = vrm.userData.mixer.clipAction(idleClip);
            idleAnimations[i].play();
        }

        // ËºâÂÖ•ËàûËπà
        for (const url of DANCE_URLS) {
            const gltf = await loader.loadAsync(url);
            const clipData = gltf.userData.vrmAnimations[0];
            const actions = currentVrms.map(vrm => {
                const clip = createVRMAnimationClip(clipData, vrm);
                const action = vrm.userData.mixer.clipAction(clip);
                action.setLoop(THREE.LoopOnce);
                action.clampWhenFinished = true;
                return action;
            });
            danceActionsMap.push(actions);
        }

        statusText.innerText = "Ê∫ñÂÇôÂ∞±Á∑íÔºÅ";
        document.querySelector('.loader').style.display = 'none';
        document.getElementById('start-btn').style.display = 'block';
    }

    // --- Ë™ûÈü≥Á≥ªÁµ± ---
    function logTTS(msg) {
        if (!isAndroid) return;
        const debug = document.getElementById('tts-debug');
        debug.style.display = 'block';
        debug.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}<br>` + debug.innerHTML;
    }

    async function unlockTTS() {
        return new Promise(resolve => {
            const u = new SpeechSynthesisUtterance("");
            u.volume = 0;
            u.onend = resolve;
            speechSynthesis.speak(u);
            setTimeout(resolve, 100);
        });
    }

    async function speak(text) {
        if (isMuted || !text) return;
        speechSynthesis.cancel();
        
        // ÁßªÈô§Á¨¶ËôüÔºåÈò≤Ê≠¢ TTS Â†±ÈåØ
        const cleanText = text.replace(/[^\u4e00-\u9fa5a-zA-Z0-9,.\?ÔºÅ„ÄÇÔºå„ÄÅ‚Ä¶~]/g, '');
        
        // Á≠âÂæÖË™ûÈü≥Ê∏ÖÂñÆ
        if (speechSynthesis.getVoices().length === 0) {
            await new Promise(r => setTimeout(r, 200));
        }

        const u = new SpeechSynthesisUtterance(cleanText);
        window.currentUtterance = u; // Èò≤Ê≠¢ GC
        
        const voices = speechSynthesis.getVoices();
        const chineseVoice = voices.find(v => v.lang.includes('zh-TW')) || voices.find(v => v.lang.includes('zh'));
        if (chineseVoice) u.voice = chineseVoice;

        u.onstart = () => {
            isSpeaking = true;
            if (!isDancing) {
                idleAnimations.forEach(a => a?.fadeOut(0.2));
                talkAnimations.forEach(a => { a?.reset(); a?.fadeIn(0.2).play(); });
            }
        };
        u.onend = () => {
            isSpeaking = false;
            talkAnimations.forEach(a => a?.fadeOut(0.5));
            if (!isDancing) idleAnimations.forEach(a => { a?.reset(); a?.fadeIn(0.5).play(); });
            currentVrms.forEach(v => v.expressionManager.setValue('aa', 0));
        };
        
        speechSynthesis.speak(u);
    }

    // --- JSON Ëß£Êûê ---
    function safeParseAIJson(text) {
        try {
            const match = text.match(/\{[\s\S]*\}/);
            if (!match) return null;
            let jsonStr = match[0].replace(/'/g, '"').replace(/,\s*([\}\]])/g, '$1');
            return JSON.parse(jsonStr);
        } catch (e) {
            return null;
        }
    }

    // --- Ë∑≥ËàûÈÇèËºØ ---
    let danceQueue = [];
    function playNextDance() {
        if (danceQueue.length === 0) {
            stopDance();
            return;
        }
        const idx = danceQueue.shift();
        const actions = danceActionsMap[idx];
        if (!actions) return playNextDance();

        actions.forEach(a => { a.reset().fadeIn(0.3).play(); });
        
        // ‰ª•Á¨¨‰∏ÄÂÄãËßíËâ≤ÁöÑ Mixer ‰ΩúÁÇ∫ÁµêÊùüÁõ£ËÅΩ
        const onFinish = () => {
            currentVrms[0].userData.mixer.removeEventListener('finished', onFinish);
            actions.forEach(a => a.fadeOut(0.3));
            playNextDance();
        };
        currentVrms[0].userData.mixer.addEventListener('finished', onFinish);
    }

    function startDance(sequence = [0,1,2,3]) {
        isDancing = true;
        isSpeaking = false;
        speechSynthesis.cancel();
        document.getElementById('dance-btn').classList.add('active');
        updateCamera(true);
        idleAnimations.forEach(a => a?.fadeOut(0.5));
        talkAnimations.forEach(a => a?.fadeOut(0.5));
        bgm.currentTime = 0; bgm.play();
        danceQueue = [...sequence];
        playNextDance();
    }

    function stopDance() {
        isDancing = false;
        document.getElementById('dance-btn').classList.remove('active');
        bgm.pause();
        updateCamera(false);
        danceActionsMap.forEach(acts => acts.forEach(a => a.fadeOut(0.5)));
        idleAnimations.forEach(a => { a?.reset().fadeIn(0.5).play(); });
    }

    // --- ‰∫ã‰ª∂Á∂ÅÂÆö ---
    document.getElementById('start-btn').addEventListener('click', async () => {
        await unlockTTS();
        document.getElementById('loading-screen').style.opacity = '0';
        setTimeout(() => document.getElementById('loading-screen').style.display = 'none', 500);
        const welcome = "ÊÅ≠ÂñúÁôºË≤°ÔºÅÊàëÊòØ‰Ω†ÁöÑ AI VTuberÔºåÁ•ù‰Ω†Êñ∞ÁöÑ‰∏ÄÂπ¥È¶¨Âà∞ÊàêÂäüÔºåËê¨‰∫ãÂ¶ÇÊÑèÔºÅ";
        addMessage(welcome, 'ai');
        speak(welcome);
        document.getElementById('user-input').disabled = false;
        document.getElementById('send-btn').disabled = false;
        
        // Ê∏¨Ë©¶ API
        testAPI();
    });

    async function testAPI() {
        try {
            const res = await fetch(API_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({contents: [{parts: [{text: "Hi"}]}]}) });
            if (res.ok) document.getElementById('status-dot').className = 'status-dot status-connected';
            else document.getElementById('status-dot').className = 'status-dot status-error';
        } catch(e) { document.getElementById('status-dot').className = 'status-dot status-error'; }
    }

    async function handleSend() {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if (!text || input.disabled) return;

        input.value = ''; addMessage(text, 'user');
        const loading = addMessage("ÊÄùËÄÉ‰∏≠...", 'system');
        
        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    contents: [...chatHistory, {role: "user", parts: [{text}]}],
                    systemInstruction: { parts: [{text: "‰Ω†ÊòØ AI VTuberÔºåÂõûÂÇ≥ JSON: {\"text\":\"...\",\"action\":\"dance_sequence|none\",\"dance_list\":[0,1,2,3]}"}] }
                })
            });
            const data = await res.json();
            const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Êä±Ê≠âÔºåÊàëÊö´ÊôÇÊñ∑Á∑ö‰∫Ü„ÄÇ";
            chatHistory.push({role: "user", parts:[{text}]}, {role:"model", parts:[{text: aiText}]});
            
            loading.remove();
            const result = safeParseAIJson(aiText);
            const msg = result ? result.text : aiText;
            addMessage(msg, 'ai');
            speak(msg);

            if (result && result.action === "dance_sequence") {
                startDance(result.dance_list || [0]);
            }
        } catch(e) {
            loading.innerText = "ÈÄ£Á∑öÁï∞Â∏∏ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ";
        }
    }

    function addMessage(text, type) {
        const display = document.getElementById('chat-display');
        const div = document.createElement('div');
        div.className = `message message-${type}`;
        div.innerText = text;
        display.appendChild(div);
        display.scrollTop = display.scrollHeight;
        return div;
    }

    document.getElementById('send-btn').onclick = handleSend;
    document.getElementById('user-input').onkeypress = e => e.key === 'Enter' && handleSend();
    document.getElementById('dance-btn').onclick = () => isDancing ? stopDance() : startDance();
    document.getElementById('mute-btn').onclick = () => {
        isMuted = !isMuted;
        document.getElementById('mute-btn').innerText = isMuted ? 'üîá' : 'üîä';
        bgm.muted = isMuted;
        if (isMuted) speechSynthesis.cancel();
    };

    // --- ÂãïÁï´Ëø¥Âúà ---
    const clock = new THREE.Clock();
    function animate() {
        requestAnimationFrame(animate);
        const delta = clock.getDelta();
        const elapsed = clock.elapsedTime;
        
        mixers.forEach(m => m.update(delta));
        currentVrms.forEach(vrm => {
            vrm.update(delta);
            if (isSpeaking && !isMuted) {
                vrm.expressionManager.setValue('aa', (Math.sin(elapsed * 15) + 1) / 2 * 0.7);
            }
        });
        renderer.render(scene, camera);
    }

    init().then(animate);
    
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        updateCamera(isDancing);
    });

</script>
</body>
</html>
