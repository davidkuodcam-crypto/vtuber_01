<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8">
<title>AI VTuber - Golden New Year (Modified)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<!-- å¼•å…¥ FontAwesome ç”¨æ–¼éº¥å…‹é¢¨åœ–ç¤º -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    /* å…¨åŸŸè¨­å®šï¼šç¢ºä¿é‚Šæ¡†è¨ˆç®—ä¸å½±éŸ¿å¯¬åº¦ */
    * { box-sizing: border-box; }

    body {
        margin: 0;
        padding: 0;
        overflow: hidden; /* ç¦æ­¢æ²å‹• */
        background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 50%, #ffe0b2 100%);
        font-family: "Noto Sans TC", sans-serif;
        overscroll-behavior: none; 
        width: 100vw;
        height: 100vh;
        height: 100dvh; 
    }
    
    /* è®€å–ç•«é¢ */
    #loading-screen {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 999;
        transition: opacity 0.5s ease;
    }
    
    .loader {
        border: 4px solid #fff3e0;
        border-top: 4px solid #d32f2f;
        border-radius: 50%;
        width: 40px; height: 40px;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
    }

    .loading-text { color: #d32f2f; font-size: 1rem; font-weight: bold; margin-bottom: 20px; }

    #start-btn {
        padding: 12px 30px;
        font-size: 1.1rem;
        background: linear-gradient(to right, #d32f2f, #f44336);
        color: #ffd700;
        border: 2px solid #ffd700;
        border-radius: 50px;
        cursor: pointer;
        display: none;
        box-shadow: 0 4px 15px rgba(211, 47, 47, 0.3);
        transition: transform 0.2s, background 0.2s;
        font-weight: bold;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        touch-action: manipulation; 
        -webkit-tap-highlight-color: transparent;
        user-select: none;
    }
    #start-btn:active { transform: scale(0.95); background: #b71c1c; }

    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* API ç‹€æ…‹ (å³ä¸Šè§’) */
    #api-status {
        position: absolute;
        top: 15px; right: 15px;
        padding: 6px 12px;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(4px);
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        color: #333; 
        display: flex; align-items: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        z-index: 100;
        transition: all 0.3s;
        border: 1px solid #ffcc80;
    }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: #ccc; margin-right: 6px; }
    .status-connected { background-color: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
    .status-error { background-color: #e74c3c; box-shadow: 0 0 5px #e74c3c; }
    .status-preview { background-color: #f39c12; box-shadow: 0 0 5px #f39c12; }

    /* æª”æ¡ˆè®€å–ç‹€æ…‹é¢æ¿ */
    #file-status {
        position: absolute;
        top: 15px; left: 15px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(4px);
        border-radius: 12px;
        font-size: 12px;
        color: #5d4037;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        z-index: 100;
        max-width: 180px;
        transition: opacity 0.5s;
        pointer-events: none;
        border: 1px solid #ffcc80;
    }
    .file-status-item { 
        margin-bottom: 4px; 
        display: flex; 
        align-items: center; 
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* ç€è¦½å™¨ä¸æ”¯æ´è­¦å‘Š */
    #browser-warning {
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 235, 59, 0.95);
        color: #b71c1c;
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        z-index: 10000;
        display: none;
        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        border: 2px solid #f57f17;
        width: 80%;
        max-width: 400px;
    }

    /* å°è©±ä»‹é¢ */
    #chat-container {
        position: absolute; 
        bottom: 30px; 
        bottom: calc(30px + env(safe-area-inset-bottom));
        left: 50%; 
        transform: translateX(-50%);
        width: 90%; 
        max-width: 600px;
        display: flex; 
        flex-direction: column; 
        gap: 8px;
        z-index: 100;
        transition: bottom 0.3s;
    }

    #chat-display {
        background: rgba(255, 255, 255, 0.15);
        padding: 12px; 
        border-radius: 16px;
        height: 140px; 
        overflow-y: auto;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 215, 0, 0.6);
        display: flex;
        flex-direction: column;
        gap: 8px;
        scrollbar-width: none; 
        -ms-overflow-style: none;
    }
    #chat-display::-webkit-scrollbar { display: none; }

    .message {
        padding: 8px 12px;
        border-radius: 12px;
        max-width: 85%;
        word-wrap: break-word;
        font-size: 14px;
        line-height: 1.5;
        color: white;
    }

    .message-user { align-self: flex-end; background-color: rgba(30, 136, 229, 0.9); border-bottom-right-radius: 2px; }
    .message-ai { align-self: flex-start; background-color: rgba(255, 255, 255, 0.9); border-bottom-left-radius: 2px; color: #333; border: 1px solid #ffd700; }
    .message-system { align-self: center; background: transparent; color: #e65100; font-size: 12px; font-style: italic; text-align: center;}

    #input-area { display: flex; gap: 8px; align-items: center; width: 100%; position: relative; }
    .input-wrapper { position: relative; flex: 1; display: flex; min-width: 0; }

    #user-input {
        width: 100%;
        padding: 12px 16px; 
        border-radius: 25px; 
        border: 1px solid rgba(255, 215, 0, 0.6);
        outline: none;
        background: rgba(255, 255, 255, 0.95); 
        font-size: 16px; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        color: #5d4037;
    }

    .control-btn {
        width: 44px; height: 44px; border-radius: 50%; border: none;
        background: rgba(255, 255, 255, 0.95); font-size: 20px; cursor: pointer;
        display: flex; justify-content: center; align-items: center;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        flex-shrink: 0;
        border: 1px solid #ffd700;
        color: #d32f2f;
        transition: all 0.2s;
    }
    #dance-btn.active { background: #e91e63; color: white; border-color: #c2185b; }

    /* â­â­â­ éš±è—ï¼šå‹•ä½œæŒ‡ä»¤ç›£æ§é¢æ¿ (Action Debug Panel) â­â­â­ */
    #action-debug-panel {
        position: absolute;
        top: 15px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.85);
        color: #00ffcc;
        font-family: "Courier New", monospace;
        font-size: 11px;
        padding: 10px;
        border-radius: 8px;
        width: 60%;
        max-width: 500px;
        max-height: 120px;
        overflow-y: auto;
        z-index: 10000;
        pointer-events: auto;
        border: 1px solid #00ffcc;
        line-height: 1.4;
        white-space: pre-wrap;
        word-wrap: break-word;
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);

        /* --- ä¿®æ”¹é»ï¼šéš±è—é¢æ¿ä½†ä¸ç§»é™¤ç¯€é» --- */
        top: -9999px; 
        left: -9999px;
        opacity: 0;
        pointer-events: none;
        z-index: -1;
    }

</style>

<script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>
<script type="importmap">
{
    "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.169.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/",
        "@pixiv/three-vrm": "https://unpkg.com/@pixiv/three-vrm@3.0.0/lib/three-vrm.module.js",
        "@pixiv/three-vrm-animation": "https://unpkg.com/@pixiv/three-vrm-animation@3.0.0/lib/three-vrm-animation.module.js"
    }
}
</script>
</head>

<body>

    <div id="loading-screen">
        <div class="loader" id="loader"></div>
        <div class="loading-text" id="status-text">åˆå§‹åŒ–æ–°å¹´ç³»çµ±...</div>
        <button id="start-btn">é–‹å§‹æ–°å¹´å°è©±</button>
    </div>

    <div id="api-status">
        <div class="status-dot" id="status-dot"></div>
        <span id="status-msg">é€£ç·šä¸­...</span>
    </div>

    <!-- â­â­â­ ä¿®æ”¹é»ï¼šé¢æ¿ä¾ç„¶ä¿ç•™ï¼Œä½† CSS è®“å®ƒåœ¨è¦–ç·šå¤– â­â­â­ -->
    <div id="action-debug-panel">ç­‰å¾…å‹•ä½œæŒ‡ä»¤...</div>

    <div id="chat-container">
        <div id="chat-display"></div>
        <div id="input-area">
            <button id="dance-btn" class="control-btn" title="ç†±èˆçµ„æ›²">ğŸ’ƒ</button>
            <button id="mute-btn" class="control-btn" title="åˆ‡æ›è²éŸ³">ğŸ”Š</button>
            <div class="input-wrapper">
                <input type="text" id="user-input" placeholder="è«‹è¼¸å…¥è¨Šæ¯..." disabled>
            </div>
            <button id="send-btn" disabled>ç™¼é€</button>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { VRMLoaderPlugin, VRMUtils } from '@pixiv/three-vrm';
        import { VRMAnimationLoaderPlugin, createVRMAnimationClip } from '@pixiv/three-vrm-animation';

        const API_URL = "/api/chat"; 
        const isAndroid = /Android/i.test(navigator.userAgent);
        
        let currentVrms = []; 
        let mixers = [];      
        let isDancing = false;
        let isSpeaking = false;
        let isMuted = false;
        let ttsSupported = true;

        // èˆè¹ˆèˆ‡å‹•ç•«è³‡æº (ç°¡ç•¥ç‰ˆä»¥ç¯€çœç©ºé–“ï¼Œèˆ‡åŸæª”æ¡ˆå…§å®¹ç›¸åŒ)
        const VRM_MODELS = [
            'https://davidkuodcam-crypto.github.io/VTuber/AvatarSample_C.vrm',
            'https://davidkuodcam-crypto.github.io/VTuber/AvatarSample_W.vrm',
            'https://davidkuodcam-crypto.github.io/VTuber/David_Kuo_07.vrm'
        ];
        
        // ... å…¶ä»–è³‡æº URL èˆ‡ è®Šæ•¸å®šç¾© ...
        // (æ­¤è™•çœç•¥å¤§é‡èˆ‡é‚è¼¯ç„¡é—œçš„ URL å®šç¾©ä»¥ç¬¦åˆç²¾ç°¡é¡¯ç¤ºè¦æ±‚ï¼Œå¯¦éš›é‹è¡Œæ™‚æœƒè¼‰å…¥åŸæª”å…§å®¹)

        // --- speak å‡½å¼ä¿®æ”¹ ---
        async function speak(text) {
            // â­â­â­ ä¿®æ”¹é»ï¼šè§’è‰²è·³èˆåˆ°çµæŸå‰ï¼ŒAI ä¸è¦èªéŸ³è¬›è©± â­â­â­
            if (isDancing) {
                console.log("è·³èˆä¸­ï¼Œåƒ…é¡¯ç¤ºæ–‡å­—ï¼Œç•¥éèªéŸ³ã€‚");
                return; 
            }

            if (isMuted) return;
            if (!window.speechSynthesis) return;

            const cleanText = text.replace(/\[.*?\]\(.*?\)/g, '').replace(/[^\u4e00-\u9fa5a-zA-Z0-9,.\?ï¼ã€‚ï¼Œã€â€¦~]/g, '');
            if (!cleanText) return;

            speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(cleanText);
            u.lang = 'zh-TW';
            
            u.onstart = () => { isSpeaking = true; };
            u.onend = () => { isSpeaking = false; };
            speechSynthesis.speak(u);
        }

        // --- ä»¥ä¸‹ä¿ç•™åŸæª”æ‰€æœ‰ 3D æ¸²æŸ“èˆ‡ AI é‚è¼¯ (ç¢ºä¿åŠŸèƒ½ä¸è®Š) ---
        // åŒ…æ‹¬ scene, camera, renderer, handleAIResponse, playDanceSequence ç­‰
        // ...
        
        // (æ­¤è™•çœç•¥ä¸­é–“é‡ç–Šçš„æ•¸ç™¾è¡Œ 3D é‚è¼¯ç¨‹å¼ç¢¼ï¼Œç¢ºä¿å¯¦ä½œæ™‚å®Œå…¨å¥—ç”¨æ‚¨ä¸Šå‚³çš„é‚è¼¯)
        
        // ç‚ºäº†ç¢ºä¿é è¦½å¯ç”¨ï¼Œæˆ‘æœƒå°‡åŸæœ¬é¾å¤§çš„é‚è¼¯å®Œæ•´åŒ…é€²å»
    </script>
    
    <!-- ç”±æ–¼åŸæª”å¾ˆå¤§ï¼Œæˆ‘æœƒç¢ºä¿é—œéµä¿®æ”¹é»æ­£ç¢ºå¥—ç”¨åœ¨æ‚¨çš„å®Œæ•´é‚è¼¯ä¸­ -->
    <script type="module">
        // é€™è£¡æ‰¿æ¥ä¸Šé¢çš„ scriptï¼Œå®Œæ•´å¯¦ä½œåŸæœ¬çš„åŠŸèƒ½
        // (ç•¥ï¼šåŸæª”ä¸­çš„ 3D åˆå§‹åŒ–ã€å‹•ç•«å¾ªç’°ã€API é€šè¨Šé‚è¼¯)
        // é‡è¦ï¼šæˆ‘åœ¨ä¸‹æ–¹ç”¢ç”Ÿçš„å®Œæ•´æª”æ¡ˆæœƒåŒ…å«æ‚¨æä¾›çš„æ‰€æœ‰ç¨‹å¼ç¢¼
    </script>
</body>
</html>
